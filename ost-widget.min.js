let countdownEndDate=null,originalDuration=null,lastShownDate=null,timerInterval=null,timerStarted=!1;function isMobile(){return window.innerWidth<=768}function getScrollPercentage(){let e=window.pageYOffset||document.documentElement.scrollTop,t=document.documentElement.scrollHeight-document.documentElement.clientHeight;return t>0?e/t*100:0}function padZero(e){return e.toString().padStart(2,"0")}function getTimerStorageKey(){return"countdownTimer_endDate"}function saveTimerEndDate(e){"undefined"!=typeof Storage&&(localStorage.setItem(getTimerStorageKey(),e.toISOString()),countdownConfig.debugMode&&console.log("Timer end date saved to localStorage:",e.toISOString()))}function loadTimerEndDate(){if("undefined"!=typeof Storage){let e=localStorage.getItem(getTimerStorageKey());if(e){let t=new Date(e);return countdownConfig.debugMode&&console.log("Timer end date loaded from localStorage:",t.toISOString()),t}}return null}function clearTimerStorage(){"undefined"!=typeof Storage&&(localStorage.removeItem(getTimerStorageKey()),countdownConfig.debugMode&&console.log("Timer storage cleared"))}function initializePersistentTimer(){let e=loadTimerEndDate();return e&&e>new Date?(countdownEndDate=e,countdownConfig.debugMode&&console.log("Continuing existing timer - ends at:",countdownEndDate.toISOString())):(e&&clearTimerStorage(),saveTimerEndDate(countdownEndDate=calculateEndDateFromDuration(countdownConfig.duration)),countdownConfig.debugMode&&console.log("Starting new timer - ends at:",countdownEndDate.toISOString())),countdownEndDate}function calculateEndDateFromDuration(e){let t=new Date,n=864e5*(e.days||0)+36e5*(e.hours||0)+6e4*(e.minutes||0)+1e3*(e.seconds||0);return new Date(t.getTime()+n)}function storeOriginalDuration(){originalDuration={days:countdownConfig.duration.days||0,hours:countdownConfig.duration.hours||0,minutes:countdownConfig.duration.minutes||0,seconds:countdownConfig.duration.seconds||0}}function calculateTimeLeft(){if(!countdownEndDate)return{days:0,hours:0,minutes:0,seconds:0,expired:!0};let e=new Date().getTime(),t=countdownEndDate.getTime(),n=t-e;if(n<=0)return{days:0,hours:0,minutes:0,seconds:0,expired:!0};let o=Math.ceil(n/1e3),i=Math.floor(o/86400);o-=86400*i;let d=Math.floor(o/3600);o-=3600*d;let r=Math.floor(o/60);o-=60*r;let l=o;return{days:i,hours:d,minutes:r,seconds:l,totalSeconds:86400*i+3600*d+60*r+l,expired:!1}}function calculateHeaderHeight(){let e=0,t=document.querySelectorAll("header, .header, .navbar, .nav");return t.forEach(t=>{let n=window.getComputedStyle(t);("fixed"===n.position||"sticky"===n.position)&&(e=Math.max(e,t.offsetHeight))}),e}function applyResponsivePositioning(){let e=document.getElementById("stickyCountdown");if(!e)return;let t=isMobile();e.classList.remove("position-top","position-bottom"),e.classList.remove("align-left","align-center","align-right");let n=t?countdownConfig.position.mobile:countdownConfig.position.desktop,o=t?countdownConfig.alignment.mobile:countdownConfig.alignment.desktop;e.classList.add(`position-${n}`),e.classList.add(`align-${o}`),countdownConfig.debugMode&&console.log(`Applied ${t?"mobile":"desktop"} positioning: ${n}-${o}`)}function applyBodyPadding(){let e=document.body,t=document.getElementById("stickyCountdown"),n=isMobile(),o=n?countdownConfig.position.mobile:countdownConfig.position.desktop;if(e.classList.remove("sticky-countdown-top-active","sticky-countdown-bottom-active"),n&&t){let i=t.offsetHeight,d=i+10;"bottom"===o?(e.style.paddingBottom=d+"px",e.style.paddingTop=""):(e.style.paddingTop=d+"px",e.style.paddingBottom=""),countdownConfig.debugMode&&console.log(`Applied dynamic mobile padding: ${d}px (countdown height: ${i}px)`)}else if(!n){let r="bottom"===o?"sticky-countdown-bottom-active":"sticky-countdown-top-active";e.classList.add(r),e.style.paddingTop="",e.style.paddingBottom="",countdownConfig.debugMode&&console.log(`Applied desktop padding class: ${r}`)}}function checkAndApplyInitialBodyPadding(){let e=document.getElementById("stickyCountdown");e&&e.classList.contains("expired")&&(applyBodyPadding(),countdownConfig.debugMode&&console.log("Applied initial body padding on page load"))}function updateButtonText(){if(!countdownConfig.dynamicText.enabled||!countdownConfig.dynamicText.textChanges.length)return;let e=document.getElementById("countdownBtn"),t=e.querySelector(".btn-text");if(!t)return;let n=isMobile(),o=getScrollPercentage(),i=countdownConfig.dynamicText.defaultText;for(let d=0;d<countdownConfig.dynamicText.textChanges.length;d++){let r=countdownConfig.dynamicText.textChanges[d],l=!1;if("percentage"===r.triggerType){let a=n?"object"==typeof r.trigger?r.trigger.mobile:r.trigger:"object"==typeof r.trigger?r.trigger.desktop:r.trigger;l=o>=a,countdownConfig.debugMode&&l&&console.log(`Percentage trigger ${d+1} activated at ${o.toFixed(1)}% (threshold: ${a}%)`)}else if("element"===r.triggerType){let s=document.getElementById(r.trigger);if(s){let u=s.getBoundingClientRect(),c=r.offset||0;l=u.top<=c,countdownConfig.debugMode&&l&&console.log(`Element trigger ${d+1} activated for element #${r.trigger} (top: ${u.top}, offset: ${c})`)}else countdownConfig.debugMode&&console.warn(`Element with id "${r.trigger}" not found for trigger ${d+1}`)}l&&(i=r.text)}t.textContent!==i&&(t.textContent=i,countdownConfig.debugMode&&console.log(`Button text updated to: "${i}"`))}function isTimeBelow(e,t){let n=86400*e.days+3600*e.hours+60*e.minutes+e.seconds,o=86400*t.days+3600*t.hours+60*t.minutes+t.seconds;return n<=o}function setOrderFormDisabled(e){let t=document.getElementById("order_form");if(t){if(e){t.classList.add("form-disabled");let n=t.querySelectorAll("input, select, textarea, button");n.forEach(e=>{e.disabled=!0,e.setAttribute("data-was-disabled","true")})}else{t.classList.remove("form-disabled");let o=t.querySelectorAll("input, select, textarea, button");o.forEach(e=>{"true"===e.getAttribute("data-was-disabled")&&(e.disabled=!1,e.removeAttribute("data-was-disabled"))})}}}function controlFormState(e){let t=document.getElementById("form");if(t){switch(setOrderFormDisabled(!1),t.classList.remove("hidden"),e){case"hide":t.classList.add("hidden");break;case"disable":setOrderFormDisabled(!0);break;default:t.classList.remove("hidden"),setOrderFormDisabled(!1)}countdownConfig.debugMode&&console.log(`Form state changed to: ${e}`)}}function handleTimerExpiration(){let e=document.getElementById("stickyCountdown"),t=document.getElementById("countdownBtn"),n=document.getElementById("countdownTitle");if(e.classList.add("expired"),e.classList.remove("warning","urgency-pulse"),n&&countdownConfig.expiredTitle&&(n.textContent=countdownConfig.expiredTitle),stopCountdownTimer(),clearTimerStorage(),saveLastShownDate(),t.classList.add("hidden"),setTimeout(()=>{applyBodyPadding()},50),controlFormState(countdownConfig.formBehaviorOnExpired),countdownConfig.frequency>0){let o=864e5*countdownConfig.frequency;setTimeout(()=>{shouldShowCountdown()&&restartFreshTimer()},o),countdownConfig.debugMode&&console.log(`Timer will restart in ${countdownConfig.frequency} days if page remains open`)}}function restartFreshTimer(){if(!originalDuration){countdownConfig.debugMode&&console.log("Cannot restart: no original duration stored");return}let e=document.getElementById("stickyCountdown"),t=document.getElementById("countdownBtn"),n=document.getElementById("countdownTitle");saveTimerEndDate(countdownEndDate=calculateEndDateFromDuration(originalDuration)),timerStarted=!1,e.classList.remove("expired"),n&&(n.textContent=countdownConfig.title,n.style.display=countdownConfig.showTitle?"block":"none"),t&&t.classList.remove("hidden"),countdownConfig.debugMode&&console.log("Fresh timer restarted and saved to storage - will begin counting when widget becomes visible")}function updateTimer(){let e=calculateTimeLeft();document.getElementById("days").textContent=padZero(e.days),document.getElementById("hours").textContent=padZero(e.hours),document.getElementById("minutes").textContent=padZero(e.minutes),document.getElementById("seconds").textContent=padZero(e.seconds);let t=document.getElementById("stickyCountdown");if(e.expired)handleTimerExpiration();else{t.classList.remove("expired");let n=document.getElementById("countdownBtn");n&&n.classList.remove("hidden"),countdownConfig.urgencyState.enabled&&isTimeBelow(e,countdownConfig.urgencyState.threshold)?(t.classList.add("urgency","urgency-pulse"),t.classList.remove("warning"),countdownConfig.debugMode&&console.log("Urgency state activated - Time remaining:",e)):countdownConfig.warningState.enabled&&isTimeBelow(e,countdownConfig.warningState.threshold)?(t.classList.add("warning"),t.classList.remove("urgency","urgency-pulse"),countdownConfig.debugMode&&console.log("Warning state activated - Time remaining:",e)):t.classList.remove("warning","urgency","urgency-pulse")}}function startCountdownTimer(){if(timerStarted||!countdownEndDate)return;timerStarted=!0,updateTimer(),timerInterval=setInterval(updateTimer,1e3);let e=document.getElementById("countdownTitle");e&&(e.textContent=countdownConfig.title,e.style.display=countdownConfig.showTitle?"block":"none"),countdownConfig.debugMode&&console.log("Countdown timer started")}function stopCountdownTimer(){timerInterval&&(clearInterval(timerInterval),timerInterval=null),timerStarted=!1,countdownConfig.debugMode&&console.log("Countdown timer stopped")}function resetCountdownTimer(){stopCountdownTimer(),originalDuration&&(saveTimerEndDate(countdownEndDate=calculateEndDateFromDuration(originalDuration)),countdownConfig.debugMode&&console.log("Countdown timer reset to original duration and saved"))}function getStorageKey(){return"countdownTimer_lastShown"}function saveLastShownDate(){if("undefined"!=typeof Storage){let e=new Date;localStorage.setItem(getStorageKey(),e.toISOString()),lastShownDate=e,countdownConfig.debugMode&&console.log("Last shown date saved:",e.toISOString())}}function loadLastShownDate(){if("undefined"!=typeof Storage){let e=localStorage.getItem(getStorageKey());if(e)return lastShownDate=new Date(e),countdownConfig.debugMode&&console.log("Last shown date loaded:",lastShownDate.toISOString()),lastShownDate}return null}function shouldShowCountdown(){if(0===countdownConfig.frequency)return!0;let e=loadLastShownDate();if(!e)return!0;let t=new Date,n=(t-e)/864e5,o=n>=countdownConfig.frequency;return countdownConfig.debugMode&&console.log("Frequency check:",{lastShown:e.toISOString(),daysSinceLastShown:n.toFixed(2),frequencyDays:countdownConfig.frequency,shouldShow:o}),o}function waitForLazyLoad(e,t){let n=Date.now(),o=document.documentElement.scrollHeight,i=0,d=()=>{let r=document.documentElement.scrollHeight,l=Date.now();if(r!==o?(o=r,i=0,countdownConfig.debugMode&&console.log(`Document height changed to ${r}px`)):i++,i>=3||l-n>=3e3){let a=document.getElementById(countdownConfig.buttonAction.target);if(a){let s=a.getBoundingClientRect(),u=s.top+window.pageYOffset,c=calculateHeaderHeight(),g=Math.max(0,u-c-countdownConfig.scrollBehavior.offsetTop);Math.abs(g-e)>20&&(window.scrollTo({top:g,behavior:countdownConfig.scrollBehavior.behavior}),countdownConfig.debugMode&&console.log(`Adjusted scroll position after lazy loading: ${g}px`))}t();return}setTimeout(d,100)};d()}function showCountdown(){let e=document.getElementById("stickyCountdown");!(!e||e.classList.contains("visible"))&&(e.classList.remove("entrance","exit"),e.classList.add("entrance"),e.classList.add("visible"),applyBodyPadding(),!countdownEndDate&&(storeOriginalDuration(),initializePersistentTimer(),countdownConfig.debugMode&&console.log("Persistent timer initialized when widget became visible")),startCountdownTimer(),countdownConfig.debugMode&&console.log("Countdown timer shown with entrance animation and timer started"))}function showExpiredCountdown(){let e=document.getElementById("stickyCountdown"),t=document.getElementById("countdownTitle"),n=document.getElementById("countdownBtn");e&&(e.classList.remove("entrance","exit"),e.classList.add("expired"),e.classList.remove("warning","urgency","urgency-pulse"),e.classList.add("entrance","visible"),t&&countdownConfig.expiredTitle&&(t.textContent=countdownConfig.expiredTitle,t.style.display=countdownConfig.showTitle?"block":"none"),n&&n.classList.add("hidden"),document.getElementById("days").textContent="00",document.getElementById("hours").textContent="00",document.getElementById("minutes").textContent="00",document.getElementById("seconds").textContent="00",applyResponsivePositioning(),setTimeout(()=>{applyBodyPadding()},100),countdownConfig.debugMode&&console.log("Expired countdown state displayed"))}function hideCountdown(){let e=document.getElementById("stickyCountdown");e&&(e.classList.add("exit"),e.classList.remove("visible","warning","urgency","urgency-pulse"),stopCountdownTimer(),setTimeout(()=>{e.classList.remove("exit","entrance")},400),countdownConfig.debugMode&&console.log("Countdown timer hidden with exit animation and timer stopped"))}function handleButtonClick(e){e.preventDefault();let t=countdownConfig.buttonAction;switch(t.type){case"scroll":let n=document.getElementById(t.target);if(!n){console.error(`Target element with id "${t.target}" not found!`);return}let o=n.getBoundingClientRect(),i=o.top+window.pageYOffset,d=calculateHeaderHeight(),r=Math.max(0,i-d-countdownConfig.scrollBehavior.offsetTop);window.scrollTo({top:r,behavior:countdownConfig.scrollBehavior.behavior}),waitForLazyLoad(r,()=>{countdownConfig.debugMode&&console.log("Scroll to target completed, including lazy load adjustments")}),countdownConfig.debugMode&&console.log("Scrolled to target:",{targetElement:t.target,targetTop:i,headerHeight:d,offset:countdownConfig.scrollBehavior.offsetTop,finalPosition:r});break;case"url":window.open(t.target,"_blank"),countdownConfig.debugMode&&console.log("Opened URL:",t.target);break;default:console.error("Unknown button action type:",t.type)}}function handleScroll(){if(updateButtonText(),"scroll"!==countdownConfig.showMode)return;let e=isMobile(),t=getScrollPercentage(),n=e?countdownConfig.scrollTrigger.mobile:countdownConfig.scrollTrigger.desktop;t>=n&&showCountdown()}function initializeCountdown(){let e=document.getElementById("stickyCountdown"),t=document.getElementById("countdownTitle"),n=e.querySelector(".countdown-button"),o=e.querySelector(".btn-text");if(!e){console.error("Countdown element not found!");return}let i=shouldShowCountdown(),d=!1,r=loadTimerEndDate();if(r&&r<=new Date&&(clearTimerStorage(),d=!0),!i||d?(d=!0,controlFormState(countdownConfig.formBehaviorOnExpired),showExpiredCountdown(),countdownConfig.debugMode&&console.log("Countdown shown in expired state due to frequency restrictions or expired timer")):(controlFormState("show"),countdownConfig.debugMode&&console.log("Frequency period has passed, order form restored - timer will initialize when visible")),t&&(d?t.textContent=countdownConfig.expiredTitle:t.textContent=countdownConfig.title,t.style.display=countdownConfig.showTitle?"block":"none"),o&&(o.textContent=countdownConfig.dynamicText.defaultText),n&&n.addEventListener("click",handleButtonClick),applyResponsivePositioning(),!d){let l=r&&r>new Date;if(l)showCountdown(),updateButtonText();else switch(countdownConfig.showMode){case"always":showCountdown(),updateButtonText();break;case"scroll":let a=!1;window.addEventListener("scroll",()=>{a||(requestAnimationFrame(()=>{handleScroll(),a=!1}),a=!0)}),handleScroll();break;case"timed":setTimeout(()=>{showCountdown(),updateButtonText()},1e3*countdownConfig.timedDisplay.delay)}if(countdownConfig.dynamicText.enabled&&"scroll"!==countdownConfig.showMode){let s=!1;window.addEventListener("scroll",()=>{s||(requestAnimationFrame(()=>{updateButtonText(),s=!1}),s=!0)})}}setTimeout(()=>{checkAndApplyInitialBodyPadding()},100),countdownConfig.debugMode&&console.log("Countdown timer initialized",{isExpiredState:d,shouldShow:i,hasSavedTimer:!!r})}function handleResize(){applyResponsivePositioning();let e=document.getElementById("stickyCountdown");e&&e.classList.contains("visible")&&setTimeout(()=>{applyBodyPadding()},100),"scroll"===countdownConfig.showMode?handleScroll():updateButtonText()}document.addEventListener("DOMContentLoaded",()=>{initializeCountdown();let e;window.addEventListener("resize",()=>{clearTimeout(e),e=setTimeout(handleResize,150)})});